{% extends "core/base.html" %}
{% load static %}
{% block title %}Dashboard — GapyPay{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">

<div class="dashboard-wrap container">
  <div class="dash-top-cards">
    <div class="card small">
      <h4>Balance</h4>
      <p class="big">₹0.00</p>
      <button class="btn btn-primary" id="addMoneyBtn">Add Money</button>
    </div>

    <div class="card small">
      <h4>UPI ID</h4>
      <p class="muted">mathivarma@icici</p>
      <button class="btn btn-ghost" id="showQR">Show QR</button>
    </div>

    <div class="card small">
      <h4>Quick Pay</h4>
      <form id="quickPayForm">
        {% csrf_token %}
        <input name="to_upi" placeholder="UPI ID or phone" class="input" required>
        <input name="amount" placeholder="Amount (INR)" class="input" required>
        <button class="btn btn-primary" type="submit">Pay</button>
            <button id="scanQrBtn" type="button" class="btn btn-secondary">Scan QR</button>

      </form>
    </div>
  </div>
  <div id="qrContainer" style="margin-top: 15px; text-align:center; display:none;">
    <h5>Scan to Pay</h5>
    <canvas id="upiQr"></canvas>
  </div>
</div>

<section class="cards-wrap">
  <div class="card recharge-card" id="rechargeCard">
    <div class="card-inner">
      <h3>Mobile Recharge</h3>
      <p>Instant recharge for mobiles, DTH & more.</p>
      <button class="btn primary btn-large" id="goRecharge">Go to Recharge</button>
    </div>
  </div>

  <div class="card stats-card">
    <div class="card-inner">
      <h3>Recent Orders</h3>
      <ul class="recent-list">
        {% for o in recent %}
          <li>{{ o.mobile }} — ₹{{ o.amount }} — <span class="muted">{{ o.status }}</span></li>
        {% empty %}
          <li class="muted">No recent orders</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</section>
  <div class="card">
    <h3>Recent Transactions</h3>
    <table class="txn-table">
      <thead><tr><th>Date</th><th>To</th><th>Amount</th><th>Provider</th><th>Status</th></tr></thead>
      <tbody>
        {% for t in recent_txns %}
        <tr>
          <td>{{ t.created_at|date:"M d, H:i" }}</td>
          <td>{{ t.to_upi|default:"-" }}</td>
          <td>₹{{ t.amount }}</td>
          <td>{{ t.provider|default:"-" }}</td>
          <td class="status-{{ t.status|lower }}">{{ t.status }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5">No recent transactions</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Payment Modal (hidden by default) -->
<div id="paymentModal" class="modal" style="display:none">
  <div class="modal-inner card">
    <button class="modal-close" id="modalClose">×</button>
    <h3>Payment Options</h3>
    <div class="payment-grid">
      <div class="methods">
        <button class="method-btn" data-provider="razorpay">Pay with Razorpay</button>
        <button class="method-btn" data-provider="gpay">GPay</button>
        <button class="method-btn" data-provider="phonepe">PhonePe</button>
        <button class="method-btn" data-provider="bhim">BHIM</button>
      </div>
              <p><strong>To:</strong> <span id="summary_to"></span></p>

      <div class="summary">
        <p><strong>To:</strong> <span id="summary_to"></span></p>
        <p><strong>Amount:</strong> ₹<span id="summary_amt"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- UPI QR Modal (desktop fallback) -->
<div id="qrModal" class="modal" style="display:none">
  <div class="modal-inner card">
    <button class="modal-close" id="qrModalClose">×</button>
    <h3>Scan to pay with UPI</h3>
    <p id="qrNote">Open your UPI app (GPay/PhonePe/BHIM) and scan the QR or copy the UPI ID below.</p>
    <img id="qrImg" src="" alt="UPI QR" style="width:260px;height:260px;border-radius:8px;display:block;margin:12px 0" />
    <div style="display:flex;gap:8px;align-items:center;">
      <input id="upiText" readonly style="flex:1;padding:8px;border-radius:6px;border:1px solid #444;background:#0b0b0b;color:#fff" />
      <button id="copyUpiBtn" class="btn">Copy</button>
    </div>
    <p style="margin-top:10px;font-size:0.9em;color:#bbb">After paying in your UPI app, refresh this page or use the app to confirm. You can also click "I paid" (if you add that flow) to poll the server for status.</p>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Razorpay checkout library -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    const e = encodeURIComponent;
    function buildUpiUri({ pa, pn, amount, tn }) {
  return `upi://pay?pa=${e(pa)}&pn=${e(pn)}&tn=${e(tn)}&am=${e(amount)}&cu=INR`;
}
    function generateQrCode(text) {
  const qrCanvas = document.getElementById("upiQr");
  const qrContainer = document.getElementById("qrContainer");
  qrContainer.style.display = "block";
  const qr = new QRious({
    element: qrCanvas,
    value: text,
    size: 200,
  });
}

// Handle Scan QR click
document.getElementById("scanQrBtn").addEventListener("click", () => {
  const form = document.getElementById("quickPayForm");
  const to_upi = form.to_upi.value.trim();
  const amount = form.amount.value.trim();

  if (!to_upi || !amount) {
    alert("Please fill both UPI ID and amount before generating QR.");
    return;
  }

  const upiLink = buildUpiUri({
    pa: to_upi,
    pn: "User",
    amount: amount,
    tn: "From App",
  });

  console.log("Generated UPI URI:", upiLink);
  generateQrCode(upiLink);
});
(function(){
  /* Elements */
  const modal = document.getElementById('paymentModal');
  const modalClose = document.getElementById('modalClose');
  const quickPayForm = document.getElementById('quickPayForm');
  const summaryTo = document.getElementById('summary_to');
  const summaryAmt = document.getElementById('summary_amt');
  const methodButtons = document.querySelectorAll('.method-btn');
const showlink = document.getElementById('showlink');
  const qrModal = document.getElementById('qrModal');
  const qrModalClose = document.getElementById('qrModalClose');
  const qrImg = document.getElementById('qrImg');
  const upiText = document.getElementById('upiText');
  const copyUpiBtn = document.getElementById('copyUpiBtn');

  /* CSRF cookie helper */
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken_cookie = getCookie('csrftoken');

  /* Modal open/close helpers */
  function openModal(to, amount){
    summaryTo.textContent = to;
    summaryAmt.textContent = amount;
    modal.style.display = 'block';
    modal.dataset.to = to;
    modal.dataset.amount = amount;
  }
  function closeModal(){ modal.style.display = 'none'; }

  modalClose.addEventListener('click', closeModal);

  quickPayForm.addEventListener('submit', async function(e){
    e.preventDefault();
    const to = quickPayForm.elements['to_upi'].value.trim();
    const amount = quickPayForm.elements['amount'].value.trim();
    if(!to || !amount) { alert('Enter recipient and amount'); return; }
    openModal(to, amount);
  });

  /* createOrder: POST to backend, expects JSON { ok:true, order_id, amount_paise, txn_id, message? } */
  async function createOrder(amount, to, provider) {
    const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value || csrftoken_cookie;
    const fd = new FormData();
    fd.append('amount', amount);
    fd.append('to_upi', to);
    fd.append('provider', provider);
    const resp = await fetch("{% url 'core:create_order' %}", {
      method: 'POST',
      headers: {'X-CSRFToken': token},
      body: fd,
      credentials: 'same-origin'
    });
    return resp.json();
  }

  /* Razorpay checkout handler (keeps your existing flow) */
  async function openRazorpay(order_id, amount_paise, txn_id, name, phone){
    const options = {
      "key": "{{ razorpay_key_id }}",
      "amount": amount_paise,
      "currency": "INR",
      "order_id": order_id,
      "name": name || "{{ user.username }}",
      "prefill": {
        "name": "{{ user.username }}",
        "email": "{{ user.email|default:'' }}",
        "contact": "{{ user.phone_number|default:'' }}"
      },
      "handler": function (response){
        const data = new FormData();
        data.append('razorpay_payment_id', response.razorpay_payment_id);
        data.append('razorpay_order_id', response.razorpay_order_id);
        data.append('razorpay_signature', response.razorpay_signature);
        data.append('txn_id', txn_id || '');
        fetch("{% url 'core:verify_payment' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || csrftoken_cookie},
          body: data,
          credentials: 'same-origin'
        }).then(r => r.json()).then(j => {
          if(j.ok){
            alert('Payment successful');
            window.location.reload();
          } else {
            alert('Payment verification failed: ' + (j.message || ''));
            window.location.reload();
          }
        }).catch(err => { console.error(err); alert('Verification error'); });
      },
      "modal": { "ondismiss": function(){ /* allow retry */ } }
    };
    const rzp = new Razorpay(options);
    rzp.open();
  }

  /* Helpers: encoding / UPI URI builders / mobile detect */
  function e(s){ return encodeURIComponent(s || ''); }
  // function buildUpiUri({ pa, pn, amount, tn }){
  //   return `upi://pay?pa=${e(pa)}&pn=${e(pn)}&tn=${e(tn)}&am=${e(amount)}&cu=INR`;
  // }
  function buildGPayIntentUri({ pa, pn, amount, tn }){
    console.log('coming')
    const base = `upi://pay?pa=${e(pa)}&pn=${e(pn)}&tn=${e(tn)}&am=${e(amount)}&cu=INR`;
    const url= `intent://${base.replace(/^upi:\/\//,'') }#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end`;
    console.log(base)
        console.log(url)

    return url;
  }
  function isMobile() {
    try {
      if (navigator.userAgentData && typeof navigator.userAgentData.mobile === 'boolean') {
        return navigator.userAgentData.mobile;
      }
    } catch(e){}
    return /Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
  }

  /* Improved QR modal functions (robust + graceful fallback) */
  function showQrModal(upiUri, paDisplay){
    try {
      // Build QR URL using Google Charts (ensure proper encoding)
      const qrData = encodeURIComponent(upiUri);
      const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${qrData}`;

      // Debug logs (open console to inspect)
      console.log('Generated UPI URI:', upiUri);
      console.log('QR image URL:', qrUrl);

      // Reset UI
      qrImg.style.display = 'block';
      qrImg.src = qrUrl;
      upiText.style.display = 'block';
      upiText.value = paDisplay;
      document.getElementById('qrNote').textContent = 'Open your UPI app (GPay/PhonePe/BHIM) and scan the QR or copy the UPI ID below.';
      qrModal.style.display = 'block';

      // Handle image load error gracefully
      qrImg.onerror = function(ev){
        console.warn('QR image failed to load:', ev);
        // hide broken image, show fallback text + message
        qrImg.style.display = 'none';
        upiText.style.display = 'block';
        upiText.value = paDisplay;
        document.getElementById('qrNote').textContent =
          'QR unavailable — copy the UPI ID below and paste it in your UPI app.';
      };
    } catch (err) {
      console.error('showQrModal error:', err);
      // fallback UI
      qrImg.style.display = 'none';
      upiText.style.display = 'block';
      upiText.value = paDisplay;
      document.getElementById('qrNote').textContent =
        'QR generation failed — copy the UPI ID below and paste it in your UPI app.';
      qrModal.style.display = 'block';
    }
  }

  function closeQrModal(){
    qrModal.style.display = 'none';
    // cleanup
    qrImg.onerror = null;
    qrImg.src = '';
    upiText.value = '';
    document.getElementById('qrNote').textContent = 'Open your UPI app (GPay/PhonePe/BHIM) and scan the QR or copy the UPI ID below.';
  }

  qrModalClose.addEventListener('click', closeQrModal);

  copyUpiBtn.addEventListener('click', async function(){
    try {
      await navigator.clipboard.writeText(upiText.value);
      copyUpiBtn.textContent = 'Copied';
      setTimeout(()=> copyUpiBtn.textContent = 'Copy', 1500);
    } catch (err) {
      console.warn('Clipboard write failed, select manually:', err);
      upiText.focus();
      upiText.select();
      alert('Unable to copy automatically — select and copy the UPI ID displayed.');
    }
  });

  /* Main method button handler (Razorpay or UPI apps with fallback) */
  methodButtons.forEach(btn => {
    btn.addEventListener('click', async function(){
      const provider = btn.dataset.provider;        // 'razorpay' | 'gpay' | 'phonepe' | 'bhim'
      const to = modal.dataset.to;     
      console.log(to)            // expected VPA like mathivarma@icici
      const amount = modal.dataset.amount;         // e.g. "1.00"
      const name = "{{ user.username }}";
      const txnNotePrefix = "GapyPay";

      if(!to || !to.includes('@')){
        alert('Please enter a valid UPI ID (example: mathivarma@icici).');
        return;
      }

      let res;
      try {
        res = await createOrder(amount, to, provider);
      } catch (err) {
        console.error(err);
        alert('Order creation failed');
        return;
      }
      if(!res || !res.ok){
        alert(res?.message || 'Order creation failed');
        return;
      }

      if(provider === 'razorpay'){
        await openRazorpay(res.order_id, res.amount_paise, res.txn_id);
        return;
      }

      const tn = "Test";
      const upiUri = buildUpiUri({ pa: to, pn: name, amount, tn });

      // Desktop -> show QR modal fallback
      if(!isMobile()){
        showQrModal(upiUri, to);
        if(typeof closeModal === 'function') closeModal();
        return;
      }
function buildPhonePeIntentUri({ pa, pn, amount, tn }) {
  const e = encodeURIComponent;

  // Base UPI parameters
  const base = `pay?pa=${e(pa)}&pn=${e(pn)}&tn=${e(tn)}&am=${e(amount)}&cu=INR`;

  // PhonePe package name: com.phonepe.app
  const phonepeIntent = `intent://${base}#Intent;scheme=upi;package=com.phonepe.app;end`;

  console.log("Generated PhonePe Intent:", phonepeIntent);
  return phonepeIntent;
}
      // Mobile -> try intent/upi link
      try {
        if(provider === 'gpay'){
          const gpayIntent = buildUpiUri({ pa: to, pn: name, amount, tn });
              showlink.textContent=gpayIntent;

          window.location.href = gpayIntent;
          // fallback to generic UPI URI a bit later
          setTimeout(()=> { window.location.href = upiUri; }, 700);
        } else {
          window.location.href = upiUri;
        }
        if(typeof closeModal === 'function') closeModal();
      } catch (err) {
        console.error('Failed to open UPI intent:', err);
        showQrModal(upiUri, to);
      }
            try {
        if(provider === 'phonepe'){
          const gpayIntent = buildUpiUri({ pa: to, pn: name, amount, tn });
          window.location.href = gpayIntent;
          // fallback to generic UPI URI a bit later
          setTimeout(()=> { window.location.href = upiUri; }, 700);
        } else {
          window.location.href = upiUri;
        }
        if(typeof closeModal === 'function') closeModal();
      } catch (err) {
        console.error('Failed to open UPI intent:', err);
        showQrModal(upiUri, to);
      }
    });
  });

})();

document.getElementById('goRecharge').addEventListener('click', function(){
  window.location.href = "{% url 'core:recharge' %}";
});
</script>

{% endblock %}
